generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ──────────────────────────────────────────────
// EXISTING MODELS
// ──────────────────────────────────────────────

model User {
  id             String   @id @default(uuid()) @db.Uuid
  phone          String?  @unique @db.VarChar(15)
  phoneVerified  Boolean  @default(false) @map("phone_verified")
  googleId       String?  @unique @map("google_id") @db.VarChar(255)
  email          String?  @db.VarChar(255)
  name           String?  @db.VarChar(255)
  profilePicture String?  @map("profile_picture") @db.VarChar(500)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Preferences
  soundEnabled   Boolean        @default(true) @map("sound_enabled")
  hapticsEnabled Boolean        @default(true) @map("haptics_enabled")

  refreshTokens     RefreshToken[]
  userProgress      UserProgress?
  lessonAttempts    LessonAttempt[]
  wordProgresses    WordProgress[]
  streakRecord      StreakRecord?
  challengeAttempts ChallengeAttempt[]
  weeklyReviews     WeeklyReview[]
  fcmTokens         FcmToken[]
  subscription      UserSubscription?

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @map("token_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

// ──────────────────────────────────────────────
// CONTENT MODELS (seeded, not user-generated)
// ──────────────────────────────────────────────

model Lesson {
  id          String   @id @default(uuid()) @db.Uuid
  orderIndex  Int      @unique @map("order_index")
  title       String   @db.VarChar(255)
  subtitle    String   @db.VarChar(500)
  wordCount   Int      @map("word_count")
  isPublished Boolean  @default(false) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")

  words            Word[]
  activities       LessonActivity[]
  lessonAttempts   LessonAttempt[]
  midLessonMessage MidLessonMessage?
  celebrationStat  CelebrationStat?
  arabicInsight    ArabicInsight?

  @@map("lessons")
}

model Word {
  id              String   @id @default(uuid()) @db.Uuid
  orderIndex      Int      @unique @map("order_index")
  arabic          String   @db.VarChar(100)
  transliteration String   @db.VarChar(100)
  meaning         String   @db.VarChar(255)
  frequency       Int
  audioUrl        String   @map("audio_url") @db.VarChar(500)
  createdAt       DateTime @default(now()) @map("created_at")

  lessonId String @map("lesson_id") @db.Uuid
  lesson   Lesson @relation(fields: [lessonId], references: [id])

  introduction   WordIntroduction?
  wordProgresses WordProgress[]
  ayahHighlights AyahHighlight[]

  @@index([lessonId])
  @@map("words")
}

model WordIntroduction {
  id    String            @id @default(uuid()) @db.Uuid
  style IntroductionStyle

  headline   String  @db.VarChar(500)
  body       String  @db.Text

  ayahText String? @map("ayah_text") @db.Text
  ayahRef  String? @map("ayah_ref") @db.VarChar(50)
  factStat String? @map("fact_stat") @db.VarChar(500)

  quickCheckQuestion String?  @map("quick_check_question") @db.VarChar(500)
  quickCheckOptions  String[] @map("quick_check_options")
  quickCheckAnswer   Int?     @map("quick_check_answer")

  wordId String @unique @map("word_id") @db.Uuid
  word   Word   @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@map("word_introductions")
}

enum IntroductionStyle {
  COGNATE
  QURAN_CONTEXT
  FUN_FACT
  QUICK_CHECK
  LIFE_CONNECTION
}

model LessonActivity {
  id         String       @id @default(uuid()) @db.Uuid
  orderIndex Int          @map("order_index")
  type       ActivityType
  payload    Json

  lessonId String @map("lesson_id") @db.Uuid
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([lessonId, orderIndex])
  @@map("lesson_activities")
}

enum ActivityType {
  MATCH
  SPOT_IN_QURAN
  QUICK_FIRE
  FILL_MEANING
}

model MidLessonMessage {
  id         String  @id @default(uuid()) @db.Uuid
  headline   String  @db.VarChar(255)
  body       String  @db.Text

  lessonId String @unique @map("lesson_id") @db.Uuid
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("mid_lesson_messages")
}

model CelebrationStat {
  id               String  @id @default(uuid()) @db.Uuid
  ayahCoverage     String  @map("ayah_coverage") @db.VarChar(255)
  cumulativeWords  Int     @map("cumulative_words")

  lessonId String @unique @map("lesson_id") @db.Uuid
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("celebration_stats")
}

enum InsightType {
  ROOT_PATTERN
  GRAMMAR_TIP
  CULTURAL_NOTE
  PATTERN_RECOGNITION
  WORD_FAMILY
}

model ArabicInsight {
  id       String      @id @default(uuid()) @db.Uuid
  type     InsightType
  title    String      @db.VarChar(255)
  body     String      @db.Text
  examples Json

  lessonId String @unique @map("lesson_id") @db.Uuid
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("arabic_insights")
}

model AyahHighlight {
  id                  String @id @default(uuid()) @db.Uuid
  surahName           String @map("surah_name") @db.VarChar(100)
  surahNum            Int    @map("surah_num")
  ayahNum             Int    @map("ayah_num")
  arabicText          String @map("arabic_text") @db.Text
  translation         String @db.Text
  highlightStartIndex Int    @map("highlight_start_index")
  highlightEndIndex   Int    @map("highlight_end_index")

  wordId String @map("word_id") @db.Uuid
  word   Word   @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@map("ayah_highlights")
}

// ──────────────────────────────────────────────
// LIBRARY CONTENT (reference, not learning path)
// ──────────────────────────────────────────────

model Surah {
  id                  String @id @default(uuid()) @db.Uuid
  number              Int    @unique
  nameArabic          String @map("name_arabic") @db.VarChar(100)
  nameEnglish         String @map("name_english") @db.VarChar(100)
  nameTransliteration String @map("name_transliteration") @db.VarChar(100)
  totalAyahs          Int    @map("total_ayahs")
  revelationType      String @map("revelation_type") @db.VarChar(20)

  ayahs SurahAyah[]

  @@map("surahs")
}

model SurahAyah {
  id          String @id @default(uuid()) @db.Uuid
  ayahNumber  Int    @map("ayah_number")
  arabicText  String @map("arabic_text") @db.Text
  translation String @db.Text

  surahId String @map("surah_id") @db.Uuid
  surah   Surah  @relation(fields: [surahId], references: [id], onDelete: Cascade)

  @@unique([surahId, ayahNumber])
  @@map("surah_ayahs")
}

model SalahStep {
  id              String  @id @default(uuid()) @db.Uuid
  orderIndex      Int     @unique @map("order_index")
  name            String  @db.VarChar(255)
  arabicText      String  @map("arabic_text") @db.Text
  transliteration String  @db.Text
  translation     String  @db.Text
  note            String? @db.Text

  @@map("salah_steps")
}

model Dua {
  id              String  @id @default(uuid()) @db.Uuid
  orderIndex      Int     @unique @map("order_index")
  title           String  @db.VarChar(255)
  occasion        String  @db.VarChar(255)
  arabicText      String  @map("arabic_text") @db.Text
  transliteration String  @db.Text
  translation     String  @db.Text
  source          String? @db.VarChar(255)

  @@map("duas")
}

// ──────────────────────────────────────────────
// USER PROGRESS MODELS
// ──────────────────────────────────────────────

model UserProgress {
  id                  String    @id @default(uuid()) @db.Uuid
  totalWordsLearned   Int       @default(0) @map("total_words_learned")
  currentLessonIndex  Int       @default(1) @map("current_lesson_index")
  onboardingCompleted Boolean   @default(false) @map("onboarding_completed")
  lastActivityAt      DateTime? @map("last_activity_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  userId String @unique @map("user_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_progress")
}

model LessonAttempt {
  id          String    @id @default(uuid()) @db.Uuid
  completed   Boolean   @default(false)
  score       Int?
  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")

  userId   String @map("user_id") @db.Uuid
  lessonId String @map("lesson_id") @db.Uuid
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, lessonId])
  @@map("lesson_attempts")
}

model WordProgress {
  id             String     @id @default(uuid()) @db.Uuid
  status         WordStatus @default(LEARNED)
  timesCorrect   Int        @default(0) @map("times_correct")
  timesIncorrect Int        @default(0) @map("times_incorrect")
  lastReviewedAt DateTime?  @map("last_reviewed_at")
  learnedAt      DateTime   @default(now()) @map("learned_at")

  userId String @map("user_id") @db.Uuid
  wordId String @map("word_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  word   Word   @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId])
  @@index([userId])
  @@map("word_progress")
}

enum WordStatus {
  LEARNED
  NEEDS_REVISION
  MASTERED
}

model StreakRecord {
  id             String    @id @default(uuid()) @db.Uuid
  currentStreak  Int       @default(0) @map("current_streak")
  longestStreak  Int       @default(0) @map("longest_streak")
  lastActiveDate DateTime? @map("last_active_date") @db.Date
  updatedAt      DateTime  @updatedAt @map("updated_at")

  userId String @unique @map("user_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("streak_records")
}

// ──────────────────────────────────────────────
// DAILY CHALLENGE MODELS
// ──────────────────────────────────────────────

model DailyChallenge {
  id        String        @id @default(uuid()) @db.Uuid
  date      DateTime      @unique @db.Date
  type      ChallengeType
  payload   Json
  createdAt DateTime      @default(now()) @map("created_at")

  attempts ChallengeAttempt[]

  @@map("daily_challenges")
}

enum ChallengeType {
  MEMORY_TEST
  FUN_FACT
  QUICK_QUIZ
  WORD_OF_THE_DAY
}

model ChallengeAttempt {
  id         String    @id @default(uuid()) @db.Uuid
  answered   Boolean   @default(false)
  correct    Boolean?
  answeredAt DateTime? @map("answered_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  userId      String @map("user_id") @db.Uuid
  challengeId String @map("challenge_id") @db.Uuid
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge   DailyChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId])
  @@map("challenge_attempts")
}

// ──────────────────────────────────────────────
// WEEKLY REVIEW
// ──────────────────────────────────────────────

model WeeklyReview {
  id          String   @id @default(uuid()) @db.Uuid
  weekNumber  Int      @map("week_number")
  year        Int
  score       Int
  totalWords  Int      @map("total_words")
  completedAt DateTime @default(now()) @map("completed_at")

  userId String @map("user_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekNumber, year])
  @@map("weekly_reviews")
}

// ──────────────────────────────────────────────
// PUSH NOTIFICATIONS
// ──────────────────────────────────────────────

model FcmToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique @db.VarChar(500)
  platform  String   @db.VarChar(10)
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  userId String @map("user_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("fcm_tokens")
}

// ──────────────────────────────────────────────
// SUBSCRIPTIONS
// ──────────────────────────────────────────────

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  BILLING_RETRY
}

enum SubscriptionPlatform {
  IOS
  ANDROID
}

model UserSubscription {
  id           String             @id @default(uuid()) @db.Uuid
  revenuecatId String             @unique @map("revenuecat_id") @db.VarChar(255)
  status       SubscriptionStatus @default(ACTIVE)
  platform     SubscriptionPlatform
  productId    String             @map("product_id") @db.VarChar(255)
  purchasedAt  DateTime           @map("purchased_at")
  expiresAt    DateTime?          @map("expires_at")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")

  userId String @unique @map("user_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_subscriptions")
}
